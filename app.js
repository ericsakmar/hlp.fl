// Generated by CoffeeScript 1.6.3
(function(){var e,t;e=function(){function e(e){this.name=e;this.tasks=[];this.finished=[]}e.wrap=function(t){var n;n=null;if(t!=null){n=new e(t.name);n.next=t.next;n.tasks=t.tasks;n.finished=t.finished}return n};e.prototype.addTask=function(e,t){return t?this.setNext(e):this.tasks.push(e)};e.prototype.removeTask=function(e){var t;if(e===this.next)return this.next=null;t=this.tasks.indexOf(e);return this.tasks.splice(t,1)};e.prototype.setNext=function(e){var t;this.next!=null&&this.addTask(this.next,!1);this.next=e;t=this.tasks.indexOf(e);if(t!==-1)return this.tasks.splice(t,1)};e.prototype.parentName=function(){var e;e=this.name.indexOf(">");return e===-1?this.name:this.name.substring(0,e)};return e}();t=function(){function e(e){this.name=e;this.created=new Date}return e}();this.app=angular.module("app",[]);this.app.run(["$rootScope",function(e){return e.appName="hlp.fl"}]);this.app.factory("Projects",function(){return{openDb:function(e){var t,n;t=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;n=t.open("hlpr",2);n.onerror=function(e){return console.log(e)};n.onsuccess=function(t){var r;r=n.result;r.onerror=function(e){return console.log(e)};return e(r)};return n.onupgradeneeded=function(e){var t,n;t=e.target.result;return n=t.createObjectStore("projects",{keyPath:"name"})}},findAll:function(t){return this.openDb(function(n){var r;r=[];return n.transaction(["projects"]).objectStore("projects").openCursor().onsuccess=function(n){var i,s;i=n.target.result;if(i!=null){s=e.wrap(i.value);(s.next!=null||s.tasks.length>0)&&r.push(s);return i["continue"]()}return t(r)}})},find:function(t,n){return this.openDb(function(r){return r.transaction(["projects"]).objectStore("projects").get(t).onsuccess=function(t){return n(e.wrap(t.target.result))}})},findOrCreate:function(t,n){return this.find(t,function(r){return r!=null?n(r):n(new e(t))})},store:function(e,t){return this.openDb(function(n){return n.transaction(["projects"],"readwrite").objectStore("projects").put(e).onsuccess=function(n){return t(e)}})}}});this.app.controller("TaskListController",["$scope","Projects",function(e,n){var r,i,s,o;o=function(){return n.findAll(function(t){var n,r,i,s,o,u,a;o=t.sort(function(e,t){console.log(e.parentName(),t.parentName());return e.parentName()<t.parentName()?-1:e.parentName()>t.parentName()?1:0});r=[];n=[];i=null;for(u=0,a=o.length;u<a;u++){s=o[u];if(i!=null&&i.name===s.parentName())n.push(s);else{i=s;n=[];n.push(i);r.push(n)}}return e.$apply(function(){e.projects=t;return e.projectGroups=r})})};o();e.createTask=function(){var u;u=i(e.newTask);return n.findOrCreate(u,function(i){var u,a,f;f=s(e.newTask);a=new t(f);u=r(e.newTask);i.addTask(a,u);return n.store(i,function(t){o();return e.newTask=null})})};i=function(e){return/^\@[\w>\-\.]+/.exec(e)[0]};s=function(e){return/\s.+!?$/.exec(e)[0].replace(/(^\s)|(!$)/g,"")};r=function(e){return e.indexOf("!")===e.length-1};e.markDone=function(e,t){e.finished.push(t);e.removeTask(t);return n.store(e,function(e){return o()})};e.markNext=function(e,t){e.setNext(t);return n.store(e,function(e){return o()})};return e.deleteTask=function(e,t){e.removeTask(t);return n.store(e,function(e){return o()})}}])}).call(this);